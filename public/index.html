<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
        This is an SEO Change
        The title was made slightly longer to fit into the "ideal length"
        I changed this due to the Woorank results of my page
        The titles on the other 2 pages were changed to match this as well
    -->
    <title>Personal Budget Homepage</title>
    <meta name="description" content="A free personal budget app">
    <meta name="keywords" content="app free budget finance">
    <!--
        This is a Semantic HTML Change
        This was added to help load the background image of the top of the page
        I changed this because I was getting Lighthouse errors about the loading of this image
    -->
    <link rel="preload" as="image" href="bg.png" fetchpriority="high">
    <!--
        This is a Semantic HTML Change
        I added this to reduce the "Render blocking requests" shown in the Lighthouse audit
    -->
    <link rel="preload" href="reset.css" as="style">
    <link rel="preload" href="main.css" as="style">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="main.css">
</head>
<body>

<a href="#main" class="skip">Skip to content</a>

    <nav role="navigation">
        <ul>
            <!--
                This is a Semantic HTML Change 
                Links were edited to lead to the right place
            -->
            <!--
                This is an A11y Change
                Added aria-label to the navbar to make screenreader experience better
            -->
            <li><a href="./" aria-label="go to homepage">Homepage</a></li>
            <!--
                This is an SEO Change
                I expanded the about and login pages only up to the navbar and "hero"
                I got a bunch of warnings about this from a Screaming Frog SEO Report
            -->
            <li><a href="about.html" aria-label="learn about the app">About</a></li>
            <li><a href="login.html" aria-label="login to the app">Login</a></li>
            <li><a href="https://google.com" aria-label="go to google">Google</a></li>
        </ul>
    </nav>

    <div class="hero" role="banner">
        <h1>Personal Budget</h1>
        <h2>A personal-budget management app</h2>
    </div>

    <!--
        This is an A11y Change
        Main was given a role of "main," the hero banner "banner," and the navigation was given the role of "navigation"
        This is to create 3 landmarks to the page to help screenreaders
    -->
    <main class="center" id="main" role="main">

        <div class="page-area">

            <!--
                This is an A11y Change
                I edited all articles to use h2 instead of h1
                This is to assist screenreaders
            -->
            <article>
                <h2>Stay on track</h2>
                <p>
                    Do you know where you are spending your money? If you really stop to track it down,
                    you would get surprised! Proper budget management depends on real data... and this
                    app will help you with that!
                </p>
            </article>
    
            <article>
                <h2>Alerts</h2>
                <p>
                    What if your clothing budget ended? You will get an alert. The goal is to never go over the budget.
                </p>
            </article>
    
            <article>
                <h2>Free</h2>
                <p>
                    This app is free!!! And you are the only one holding your data!
                </p>
            </article>
    
            <article>
                <h2>Results</h2>
                <p>
                    People who stick to a financial plan, budgeting every expense, get out of debt faster!
                    Also, they to live happier lives... since they expend without guilt or fear... 
                    because they know it is all good and accounted for.
                </p>
            </article>

            <!--
                Added div with charts class to use CSS to stack the charts
                Putting them side-by-side didn't look right to me
            -->
            <div class="charts">
                <article>
                    <h2>Budget Chart</h2>
                    <p>
                        <canvas id="myChart" width="400" height="400"></canvas>
                    </p>
                </article>

                <article style="max-width: none; align-content: center;">
                    <h2>D3JS Chart</h2>
                    <div id="d3chart"></div>
                </article>
            </div>

        </div>

    </main>

    <footer class="bottom">
        <div class="center">
            All rights reserved &copy; Matthew Bachelder
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.min.js" integrity="sha512-quHCp3WbBNkwLfYUMd+KwBAgpVukJu5MncuQaWXgCrfgcxCJAq/fo+oqrRKOj+UKEmyMCG3tb8RB63W+EmrOBg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>

    <!--
        This is an SEO Change
        I edited the localhost link to be https instead of http
        This allowed it to pass a "best practices" check against redirecting to http instead of https
    -->
    <script>
        //This is for the ChartJS chart
        var dataSource = {
                datasets: [
                    {
                        data: [],
                        backgroundColor: [
                            '#ffcd56',
                            '#ff6384',
                            '#36a2eb',
                            '#fd6b19',
                            '#4bc0c0',
                            '#9966ff',
                            '#8bc34a',
                        ]
                    }
                ],
                labels: []
            };

        function createChart() {
            var ctx = document.getElementById('myChart').getContext('2d');
            var myPieChart = new Chart(ctx, {
                type: 'pie',
                data: dataSource
            });
        }

        function getBudget() {
            axios.get('/budget')
            .then(function (res) {
                for (var i = 0; i < res.data.myBudget.length; i++) {
                    dataSource.datasets[0].data[i] = res.data.myBudget[i].budget;
                    dataSource.labels[i] = res.data.myBudget[i].title;
                }
                createChart();
                color.domain(dataSource.labels);
                change(dataAssign());
            });
        }

        getBudget();

        //This is for the D3JS chart
        var svg = d3.select("#d3chart")
            .append("svg")
            .append("g");

        svg.append("g")
            .attr("class", "slices");
        svg.append("g")
            .attr("class", "labels");
        svg.append("g")
            .attr("class", "lines");

        var width = 960,
            height = 400,
            radius = Math.min(width, height) / 2;
        
        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d.value;
            });
        
        var arc = d3.svg.arc()
            .outerRadius(radius * 0.8)
            .innerRadius(radius * 0.4);

        var outerArc = d3.svg.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

        svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var key = function(d) {
            return d.data.label;
        };

        var color = d3.scale.ordinal()
            .domain(dataSource.labels)
            .range(dataSource.datasets[0].backgroundColor);

        function dataAssign() {
            var labels = color.domain();
            return labels.map(function(label, i) {
                return { label: label, value: dataSource.datasets[0].data[i] };
            });
        }

        function change(data) {
            //  slices --------------------------------------------------------------------------------------
            var slice = svg.select(".slices").selectAll("path.slice")
                .data(pie(data), key);
            
            slice.enter()
                .append("path")
                .style("fill", function(d) {
                    return color(d.data.label);
                })
                .attr("class", "slice")
                .attr("d", arc);

            slice.exit()
                .remove();

            //  text labels --------------------------------------------------------------------------------------
            var text = svg.select(".labels").selectAll("text")
                .data(pie(data), key);

            text.enter()
                .append("text")
                .attr("dy", ".35em")
                .attr("transform", d => {
                    var pos = outerArc.centroid(d);
                    pos[0] = radius * 1.05 * (midAngle(d) < Math.PI ? 1 : -1);
                    return "translate(" + pos + ")";
                })
                .style("text-anchor", d => midAngle(d) < Math.PI ? "start":"end")
                .style("fill", "black")
                .style("font-size", "14px")
                .style("font-family", "Tahoma, Arial")
                .text(d => d.data.label);

            function midAngle(d) {
                return d.startAngle + (d.endAngle - d.startAngle)/2;
            }

            text.exit()
                .remove();

            //slice to text polylines --------------------------------------------------------------------------------------
            
            var polyline = svg.select(".lines").selectAll("polyline")
                .data(pie(data), key);
                
            polyline.enter()
                .append("polyline")
                .attr("points", d => {
                    var pos = outerArc.centroid(d);
                    pos[0] = radius * 1.05 * (midAngle(d) < Math.PI ? 1 : -1);
                    return [arc.centroid(d), outerArc.centroid(d), pos];
                });

            polyline.exit()
                .remove();
        };
    </script>

</body>
</html>